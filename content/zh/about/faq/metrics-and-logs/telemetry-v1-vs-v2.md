---
title: 代理内遥测（v2）和基于 Mixer 的遥测（v1）报告的遥测有什么区别？
weight: 10
---

与基于 Mixer 的遥测 (v1) 方法相比，代理内遥测 (v2) 降低了资源成本并提高了代理性能，是 Istio 中呈现遥测的首选机制。
但是，v1 和 v2 之间报告的遥测数据区别不大，如下所列：

* **网格外流量缺少标签**

  代理内遥测依赖于 Envoy 代理之间的元数据交换来收集对​​等工作负载名称、命名空间和标签等信息。
  在基于 Mixer 的遥测中，此功能由 Mixer 执行，作为将请求属性与平台数据组合的一部分。
  此元数据交换由 Envoy 代理通过为 HTTP 协议添加特定 HTTP 标头或为 TCP 协议增加 ALPN 协议来执行，
  如[此处](/zh/docs/tasks/observability/metrics/tcp-metrics/#understanding-tcp-telemetry-collection)所述。
  这需要在客户端和服务器工作负载中注入 Envoy 代理，这意味着当一个对等点不在网格中时报告的遥测数据将缺少如工作负载名称、命名空间和标签等对等点属性。
  但是，如果两个对等点都注入了代理，则[此处](/zh/docs/reference/config/metrics/)提到的所有标签都可以在生成的指标中使用。
  当服务器工作负载脱离网格时，服务器工作负载元数据仍被分发到客户端边车，导致客户端指标填充了服务器工作负载元数据标签。

* **TCP 元数据交换需要 mTLS**

  TCP 元数据交换依赖于 [Istio ALPN 协议](/zh/docs/tasks/observability/metrics/tcp-metrics/#understanding-tcp-telemetry-collection)，
  该协议需要启用双向 TLS (mTLS) 以便 Envoy 代理能够成功交换元数据。
  这意味着如果您的集群中未启用 mTLS，则 TCP 协议的遥测将不包括工作负载名称、命名空间和标签等对等信息。

* **没有为直方图指标配置自定义存储桶的机制**

  基于 Mixer 的遥测支持为直方图类型指标（如请求持续时间和 TCP 字节大小）自定义存储桶。
  代理内遥测没有这样的可用机制。此外，与基于 Mixer 的遥测中的秒数相比，代理内遥测中可用于延迟指标的存储桶以毫秒为单位。
  但是，默认情况下，代理内遥测中有更多存储桶可用于较低延迟级别的延迟指标。

* **短期指标没有指标过期**

  基于 Mixer 的遥测支持指标过期，即在可配置的时间量内未生成的指标将被取消注册以供 Prometheus 采集。
  这在生成短期指标的场景（例如一次性作业）中很有用。取消注册指标可防止报告将来不再更改的指标，
  从而减少 Prometheus 中的网络流量和存储。这个过期机制在代理内遥测中不可用。
  可以在[此处](/zh/about/faq/#metric-expiry)找到解决此问题的方法。
