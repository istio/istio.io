---
---
1. Створіть config map, завантаживши [custom-bootstrap-runtime.yaml](/news/security/istio-security-2020-007/custom-bootstrap-runtime.yaml). Оновіть `global_downstream_max_connections` у config map відповідно до кількості одночасних зʼєднань, необхідних для окремих екземплярів шлюзу у вашому розгортанні. Як тільки ліміт буде досягнуто, Envoy почне відхиляти TCP зʼєднання.

    {{< text bash >}}
    $ kubectl -n istio-system apply -f custom-bootstrap-runtime.yaml
    {{< /text >}}

2. Застосуйте патч до розгортання ingress gateway для використання вище зазначеної конфігурації. Завантажте [gateway-patch.yaml](/news/security/istio-security-2020-007/gateway-patch.yaml) та застосуйте його за допомогою наступної команди.

    {{< text bash >}}
    $ kubectl --namespace istio-system patch deployment istio-ingressgateway --patch "$(cat gateway-patch.yaml)"
    {{< /text >}}

3. Переконайтесь, що нові ліміти застосовані.

    {{< text bash >}}
    $ ISTIO_INGRESS_PODNAME=$(kubectl get pods -l app=istio-ingressgateway -n istio-system  -o jsonpath="{.items[0].metadata.name}")
    $ kubectl --namespace istio-system exec -i -t  "${ISTIO_INGRESS_PODNAME}" -c istio-proxy -- curl -sS http://localhost:15000/runtime

    {
     "entries": {
      "overload.global_downstream_max_connections": {
        "layer_values": [
          "",
          "250000",
          ""
        ],
        "final_value": "250000"
      }
     },
     "layers": [
      "static_layer_0",
      "admin"
     ]
    }
    {{< /text >}}
