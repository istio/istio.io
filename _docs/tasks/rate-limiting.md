---
title: Enabling Rate Limits
overview: This task shows you how to use Istio to dynamically limit the traffic to a service.
          
order: 40

layout: docs
type: markdown
---

This task shows you how to use Istio to dynamically limit the traffic to a service.

## Before you begin

* Setup Istio by following the instructions in the
  [Installation guide](/docs/tasks/installing-istio.html).

* Deploy the [bookinfo](/docs/samples/bookinfo.html) sample application.

* Initialize the application version routing by either first doing the
  [request routing](/docs/tasks/request-routing.html) task or by running following
  commands:
  
  ```bash
  istioctl create -f route-rule-all-v1.yaml
  istioctl replace -f route-rule-reviews-v2-v3.yaml
  ```
* Ensure that you can use [istioctl mixer](/docs/reference/istioctl/istioctl_mixer.html#synopsis) by setting up port forwading if needed.

## Rate limits

Istio enables users to rate limit traffic to a service.
 
Consider `ratings` as an external paid service like Rotten TomatoesÂ® with `5qps` free quota.
Using Istio we can ensure that `5qps` is not breached.  

1. Configure mixer with the rate limit:

   ```bash
   istioctl mixer rule create global ratings.default.svc.cluster.local -f ratelimit.yml
   ```
   where ratelimit.yml is 
   ```yaml
   rules:
   - aspects:
     - kind: quotas
       params:
         quotas:
         - descriptorName: RequestCount
           maxAmount: 5
           expiration: 1s
   ```
   `istioctl` sets configuration for `subject=ratings.default.svc.cluster.local`

2. Generate load on the `productpage` with the following command:

   ```bash
   while true; do curl -s -o /dev/null http://$GATEWAY_URL/productpage; done
   ```
   
   If you refresh the `productpage` (http://$GATEWAY_URL/productpage) while the load 
   generator is running (i.e., generating more than 5 req/s), the traffic generated by
   your browser will be rate limited. When `reviews` service is unable to access `ratings`
   service you stop seeing stars on the UI.

## Conditional rate limits

In the previous example we applied a rate limit to the `ratings` service without regard
to any other attributes. It is possible to conditionally apply rate limits based on 
attributes like the source of the traffic.

The following configuration applies a `5qps` rate limit only to version `v3` of `reviews`.

1. Configure mixer with the conditional rate limit:

   ```bash
   istioctl mixer rule create global ratings.default.svc.cluster.local -f ratelimit-conditional.yml
   ```
   where ratelimit-conditional.yml is 
   ```yaml
   rules:
   - selector: source.labels["app"]=="reviews" && source.labels["version"] == "v3"  
     aspects:
     - kind: quotas
       params:
         quotas:
         - descriptorName: RequestCount
           maxAmount: 5
           expiration: 1s
   ```
2. Generate load on the `productpage` with the following command:

   ```bash
   while true; do curl -s -o /dev/null http://$GATEWAY_URL/productpage; done
   ```
   
   If you refresh the `productpage` (http://$GATEWAY_URL/productpage) while the load 
   generator is running (i.e., generating more than 5 req/s), the traffic generated by
   your browser will be rate limited. 

   Since the `reviews-v3` service is unable to access `ratings` we stop seeing `red` stars on the UI.


## Dimensioned rate limits [WIP]

## What's next
* Learn more about [Mixer](/docs/concepts/policy-and-control/mixer.html) and [Mixer Config](/docs/concepts/policy-and-control/mixer-config.html).
* Discover the full [Attribute Vocabulary](/docs/reference/attribute-vocabulary.html).
* Read the reference guide to [Writing Config](/docs/reference/writing-config.html).

