---
title: Integrating Virtual Machines
overview: This sample deploys the Bookinfo services across Kubernetes and a set of virtual machines, and illustrates how to use the Istio service mesh to control this infrastructure as a single mesh.

order: 60
layout: docs
type: markdown
---
{% include home.html %}

This sample deploys the Bookinfo services across Kubernetes and a set of
Virtual Machines, and illustrates how to use Istio service mesh to control
this infrastructure as a single mesh.

> Note: this guide is still under development and only tested on Google Cloud Platform.
  On IBM Bluemix or other platforms where overlay network of Pods is isolated from VM network,
  VMs cannot initiate any direct communication to Kubernetes Pods even when using Istio.

## Overview


<figure><img src="./img/mesh-expansion.svg" alt="BookInfo Application with Istio Mesh Expansion" title="BookInfo Application with Istio Mesh Expansion" />
<figcaption>BookInfo Application with Istio Mesh Expansion</figcaption></figure>

<!-- source of the drawing https://docs.google.com/drawings/d/1gQp1OTusiccd-JUOHktQ9RFZaqREoQbwl2Vb-P3XlRQ/edit -->


## Before you begin

* Setup Istio by following the instructions in the
  [Installation guide]({{home}}/docs/setup/kubernetes/quick-start.html).

* Deploy the [BookInfo]({{home}}/docs/guides/bookinfo.html) sample application.
* Create a VM named 'mysqldb' in the same project as Istio cluster, and [Join the Mesh]({{home}}/docs/setup/kubernetes/mesh-expansion.html).

## Running mysql on the VM

We will first install mysql on the VM, and configure it as a backend for the ratings service.

On the VM:
```bash
  sudo apt-get update && sudo apt-get install -y mariadb-server
  sudo mysql
  # Grant remote access by root to db server
  GRANT ALL PRIVILEGES ON *.* TO 'root'@'%' IDENTIFIED BY 'password' WITH GRANT OPTION;
  quit;
  # Allow remote access to mysql
  sudo sed -i 's/^bind-address\(.*\)/#bind-address\1/g' /etc/mysql/mariadb.conf.d/50-server.cnf
  sudo systemctl restart mysql

```
On the VM add ratings database to mysql. To make it easy to visually inspect the difference in the output of the bookinfo application you can change the ratings that are generated by ratings service.
```bash
  # Add ratings db to the mysql db
  curl -q https://raw.githubusercontent.com/istio/istio/master/samples/bookinfo/src/mysql/mysqldb-init.sql | sed -e 's/VALUES (\(.*\),.*/VALUES (\1, 1);/g' | sudo mysql
```
## Find out the IP address of the VM that will be used to add it to the mesh

On the VM:
```bash
   hostname -I
```

## Registering the mysql service with the mesh
On a host with access to istioctl commands register the VM and mysql db service
```bash
   istioctl -n default register mysqldb <ip-address-of-vm> 3306
```

###  Cluster admin

  If you previously run the mysql bookinfo on kubernetes, you need to remove the k8s mysql service:

  ```bash
  kubectl delete service mysql
  ```

  Note that the 'mysqldb' virtual machine does not need and should not have special kubernetes priviledges.

## Using the mysql service

The ratings service in bookinfo will use the DB on the machine. To verify it works, create versio 2 of the ratings service that uses the mysql db on the VM. Then specify route rules that force review service to use the ratings version 2.
```bash
# Create the version of ratings service that will use mysql back end
kubectl create -f samples/bookinfo/kube/bookinfo-mysql.yaml

# Create route rules that will force bookinfo to use the ratings back end
istioctl create -f samples/bookinfo/kube/route-rule-ratings-db.yaml
```
You can verify the output of bookinfo application is going to show 1 star for both the reviewers.

More details here soon.
See the [MySQL](https://github.com/istio/istio/blob/master/samples/rawvm/README.md) document in the meantime.
