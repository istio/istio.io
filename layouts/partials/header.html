{{ $home := .Site.GetPage "home" }}

{{/* --- Version Logic --- */}}
{{ $mainVersionFromYaml := site.Data.versions.main }}
{{ $currentBuildVersionId := .Site.Params.currentVersionId | default $mainVersionFromYaml }}
{{ $isLatestBuild := eq $currentBuildVersionId $mainVersionFromYaml }}
{{ $isDocsPage := eq .Section "docs" }}

{{ $currentPathSegmentForJS := "" }}
{{ if $isLatestBuild }}
    {{ $currentPathSegmentForJS = "latest" }}
{{ else }}
    {{ $currentPathSegmentForJS = printf "v%s" $currentBuildVersionId }}
{{ end }}

<header class="main-navigation {{ if .IsHome }}main-navigation--transparent{{ end }}">
    <nav class="main-navigation-wrapper container-l">
        <div class="main-navigation-header">
            <a id="brand" href="{{ $home.Permalink }}" aria-label="logotype">
                <span class="logo">{{ with resources.Get "inline_images/istio-logo-with-brand.svg" }}{{ .Content | safeHTML }}{{ end }}</span>
            </a>

            <button id="hamburger" class="main-navigation-toggle" aria-label="Open navigation">
                {{ partial "icon.html" "menu-hamburger" }}
            </button>

            <button id="menu-close" class="main-navigation-toggle" aria-label="Close navigation">
                {{ partial "icon.html" "menu-close" }}
            </button>
        </div>

        <div id="header-links" class="main-navigation-links-wrapper">
            <ul class="main-navigation-links">
                {{ $currentPage := .}}
                {{ range .Site.Menus.main }}
                    {{ $active := or (eq $currentPage.Title .Name) (or ($currentPage.HasMenuCurrent "main" .) ($currentPage.IsMenuCurrent "main" .)) }}

                    {{ if eq .Name "Documentation" }}
                        <li class="main-navigation-links-item">
                            <a href="{{ .URL | relLangURL }}" class="main-navigation-links-link {{ if and $isLatestBuild }}has-dropdown{{ end }} {{ if $active }}active{{ end }}">
                                <span>{{ .Name }}</span>
                                {{ if and $isDocsPage}}
                                    {{ partial "icon.html" "dropdown-arrow" }}
                                {{ end }}
                            </a>

                            {{ if and $isLatestBuild $isDocsPage }}
                                <ul class="main-navigation-links-dropdown">
                                    {{/* --- START DYNAMIC VERSION GENERATION (Always 5 items) --- */}}
                                    {{ $startVersionString := site.Data.versions.main }}
                                    {{ $parts := split $startVersionString "." }}

                                    {{ if eq (len $parts) 2 }}
                                        {{ $startMajor := index $parts 0 | int }}
                                        {{ $startMinor := index $parts 1 | int }}
                                        {{ $numberOfVersionsToList := 5 }}

                                        {{ range $i, $e := seq $numberOfVersionsToList }}
                                            {{ $minorOffset :=  $i }} {{/* can subtract from i to show preliminary */}}
                                            {{ $genMinor := sub $startMinor $minorOffset }}
                                            {{ $genMajor := $startMajor }} {{/* Assumes we stay within the same major for these 5 versions */}}

                                            {{/* Only generate if the minor version is valid (e.g., >= 0) */}}
                                            {{/* And we are still on the same major as the start version */}}
                                            {{ if and (eq $genMajor $startMajor) (ge $genMinor 0) }}
                                                {{ $currentGenVersionString := printf "%d.%d" $genMajor $genMinor }}
                                                {{ $displayName := "" }}
                                                {{ $pathSegment := "" }}
                                                {{ $isActiveLink := false }}

                                                {{ if eq $minorOffset 0 }} {{/* First item is the "main" version from YAML */}}
                                                    {{ $displayName = printf "v%s (Latest)" $currentGenVersionString }}
                                                    {{ $pathSegment = "latest" }}
                                                    {{/* This item is active because we are on the latest build */}}
                                                    {{ $isActiveLink = true }}
                                                {{ else }}
                                                    {{ $displayName = printf "v%s" $currentGenVersionString }}
                                                    {{ $pathSegment = printf "v%s" $currentGenVersionString }}
                                                    {{/* Older versions cannot be "active" in this dropdown */}}
                                                {{ end }}

                                                <li class="main-navigation-links-dropdown-item">
                                                    <a href="javascript:void(0);"
                                                       data-pathsegment="{{ $pathSegment }}"
                                                       onclick="navigateToVersionSimple(this.dataset.pathsegment); return false;"
                                                       class="main-navigation-links-link {{ if $isActiveLink }}active-version-link{{ end }}">
                                                        {{ $displayName }}
                                                    </a>
                                                </li>
                                            {{ end }} {{/* end if valid generated version */}}
                                        {{ end }} {{/* End range seq iterations */}}
                                    {{ else }}
                                        <li class="main-navigation-links-dropdown-item"><span style="padding: .5rem 1.4rem; color: #ccc;">Error: Invalid 'main' version format in versions.yaml.</span></li>
                                    {{ end }} {{/* end if valid parts for startVersionString */}}
                                    {{/* --- END DYNAMIC VERSION GENERATION --- */}}
                                </ul>
                            {{ end }} {{/* end if $isLatestBuild */}}
                        </li>
                    {{ else if .HasChildren }}
                        <li class="main-navigation-links-item">
                            <a {{ if ne .URL "" }}href="{{ .URL | relLangURL  }}"{{end}} class="main-navigation-links-link has-dropdown {{ if $active }}active{{ end }}">
                                <span>{{ .Name }}</span>
                                {{ partial "icon.html" "dropdown-arrow" }}
                            </a>

                            <ul class="main-navigation-links-dropdown">
                                {{ range .Children }}
                                    <li class="main-navigation-links-dropdown-item">
                                        <a href="{{ .URL | relLangURL }}" class="main-navigation-links-link">{{ .Name }}</a>
                                    </li>
                                {{ end }}
                            </ul>
                        </li>
                    {{ else }}
                        <li class="main-navigation-links-item">
                            <a {{ if ne .URL "" }}href="{{ .URL | relLangURL }}"{{end}} class="main-navigation-links-link {{ if $active }}active{{ end }}">
                                <span>{{ .Name }}</span>
                            </a>
                        </li>
                    {{ end }}
                {{ end }}
            </ul>

            <div class="main-navigation-footer">
                <button id="search-show" class="search-show" title='{{ i18n "search" }}' aria-label='{{ i18n "search_label" }}'>{{ partial "icon.html" "magnifier" }}</button>
                <a href='{{ "/docs/setup/getting-started" | relLangURL }}' class="btn btn--primary" id="try-istio">{{ i18n "try_istio" }}</a>
            </div>
            
        </div>

        <form id="search-form" class="search" name="cse" role="search">
            {{ if .Site.Data.args.preliminary }}
                <input type="hidden" name="cx" value="{{ .Site.Data.args.preliminary_search_engine_id }}" />
            {{ else if or .Site.Data.args.archive .Site.Data.args.archive_landing }}
                <input type="hidden" name="cx" value="{{ .Site.Data.args.archive_search_engine_id }}" />
            {{ else }}
                <input type="hidden" name="cx" value="{{ .Site.Data.args.main_search_engine_id }}" />
            {{ end }}
            <input type="hidden" name="ie" value="utf-8" />
            <input type="hidden" name="hl" value="{{ .Page.Lang }}" />
            <input type="hidden" id="search-page-url" value="{{ "/search" | relLangURL }}" />
            <input id="search-textbox" class="search-textbox form-control" name="q" type="search" aria-label='{{ i18n "search" }}' placeholder='{{ i18n "search_label" }}' />
            <button id="search-close" title='{{ i18n "search_cancel" }}' type="reset" aria-label='{{ i18n "search_cancel" }}'>{{ partial "icon.html" "menu-close" }}</button>
        </form>
    </nav>
</header>

<script>
  function navigateToVersionSimple(selectedVersionPathSegment) {
    const currentFullPath = window.location.pathname;
    const currentVersionPathSegment = {{ $currentPathSegmentForJS | jsonify }};
    const selectedTargetSegment = selectedVersionPathSegment;

    if (!currentVersionPathSegment && currentVersionPathSegment !== "" ) {
        const fallbackBase = selectedTargetSegment === 'latest' ? '/latest/' : ('/' + selectedTargetSegment + '/');
        window.location.href = fallbackBase;
        return;
    }

    let contentPath = '';
    let foundContent = false;
    const knownContentPrefixes = ['docs/', 'blog/', 'news/', 'about/', 'search/', 'get-involved/'];

    for (const prefix of knownContentPrefixes) {
        const index = currentFullPath.indexOf('/' + prefix);
        if (index > -1) {
            contentPath = currentFullPath.substring(index + 1);
            foundContent = true;
            break;
        }
    }

    if (!foundContent) {
        const currentBaseForCheck = currentVersionPathSegment === 'latest' ? '/latest/' : '/' + currentVersionPathSegment + '/';
        if (currentFullPath === '/' || currentFullPath === currentBaseForCheck || currentFullPath === currentBaseForCheck.slice(0,-1)) {
             contentPath = '';
        } else {
            contentPath = 'docs/'; // Default to docs root of target version
        }
    }
    
    let newBase = selectedTargetSegment === 'latest' ? '/latest/' : ('/' + selectedTargetSegment + '/');
    // Ensure newBase ends with a slash if contentPath is not empty or already starts with one
    if (contentPath !== "" && !newBase.endsWith('/')) {
        newBase += '/';
    }
    if (contentPath.startsWith('/')) { // Avoid double slash if contentPath accidentally starts with /
        contentPath = contentPath.substring(1);
    }
    
    let finalUrl = newBase + contentPath;
    finalUrl = finalUrl.replace(/\/\//g, '/'); // Replace double slashes

    window.location.href = finalUrl;
  }
</script>