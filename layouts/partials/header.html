{{ $home := .Site.GetPage "home" }}

{{/* --- Version Logic (needed for JS and conditional dropdown) --- */}}
{{ $versionsData := site.Data.versions }}
{{ $currentVersionIDFromParams := .Site.Params.currentVersionId | default ($versionsData.latest_version | default "") }}
{{ $latestVersionID := $versionsData.latest_version | default "" }}
{{ $isLatestBuild := eq $currentVersionIDFromParams $latestVersionID }}
{{ $isDocsPage := eq .Section "docs" }}

{{/* Calculate currentPathSegment - needed by navigateToVersionSimple JS function */}}
{{ $currentPathSegment := "" }}
{{ range $versionsData.versions }}{{ if eq .id $currentVersionIDFromParams }}{{ $currentPathSegment = .path_segment }}{{ end }}{{ end }}


<header class="main-navigation {{ if .IsHome }}main-navigation--transparent{{ end }}">
    <nav class="main-navigation-wrapper container-l">
        <div class="main-navigation-header">
            <a id="brand" href="{{ $home.Permalink }}" aria-label="logotype">
                <span class="logo">{{ with resources.Get "inline_images/istio-logo-with-brand.svg" }}{{ .Content | safeHTML }}{{ end }}</span>
            </a>

            <button id="hamburger" class="main-navigation-toggle" aria-label="Open navigation">
                {{ partial "icon.html" "menu-hamburger" }}
            </button>

            <button id="menu-close" class="main-navigation-toggle" aria-label="Close navigation">
                {{ partial "icon.html" "menu-close" }}
            </button>
        </div>

        <div id="header-links" class="main-navigation-links-wrapper">
            <ul class="main-navigation-links">
                {{ $currentPage := .}}
                {{ range .Site.Menus.main }}
                    {{ $active := or (eq $currentPage.Title .Name) (or ($currentPage.HasMenuCurrent "main" .) ($currentPage.IsMenuCurrent "main" .)) }}

                    {{ if eq .Name "Documentation" }}
                        <li class="main-navigation-links-item">
                            <a href="{{ .URL | relLangURL }}" class="main-navigation-links-link {{ if and $versionsData }}has-dropdown{{ end }} {{ if $active }}active{{ end }}">
                                <span>{{ .Name }}</span>
                                {{ partial "icon.html" "dropdown-arrow" }}
                            </a>

                            {{ if and $versionsData }}
                                <ul class="main-navigation-links-dropdown">
                                    {{ range $versionsData.versions }}
                                        <li class="main-navigation-links-dropdown-item">
                                            <a href="javascript:void(0);"
                                               data-pathsegment="{{ .path_segment }}"
                                               onclick="navigateToVersionSimple(this.dataset.pathsegment); return false;"
                                               class="main-navigation-links-link {{ if eq .id $currentVersionIDFromParams }}active-version-link{{ end }}">
                                                {{ .display_name }}
                                            </a>
                                        </li>
                                    {{ end }}
                                </ul>
                            {{ end }}
                        </li>
                    {{ else if .HasChildren }}
                        <li class="main-navigation-links-item">
                            <a {{ if ne .URL "" }}href="{{ .URL | relLangURL  }}"{{end}} class="main-navigation-links-link has-dropdown {{ if $active }}active{{ end }}">
                                <span>{{ .Name }}</span>
                                {{ partial "icon.html" "dropdown-arrow" }}
                            </a>

                            <ul class="main-navigation-links-dropdown">
                                {{ range .Children }}
                                    <li class="main-navigation-links-dropdown-item">
                                        <a href="{{ .URL | relLangURL }}" class="main-navigation-links-link">{{ .Name }}</a>
                                    </li>
                                {{ end }}
                            </ul>
                        </li>
                    {{ else }}
                        <li class="main-navigation-links-item">
                            <a {{ if ne .URL "" }}href="{{ .URL | relLangURL }}"{{end}} class="main-navigation-links-link {{ if $active }}active{{ end }}">
                                <span>{{ .Name }}</span>
                            </a>
                        </li>
                    {{ end }}
                {{ end }}
            </ul>

            <div class="main-navigation-footer">
                <button id="search-show" class="search-show" title='{{ i18n "search" }}' aria-label='{{ i18n "search_label" }}'>{{ partial "icon.html" "magnifier" }}</button>
                <a href='{{ "/docs/setup/getting-started" | relLangURL }}' class="btn btn--primary" id="try-istio">{{ i18n "try_istio" }}</a>
            </div>
            
        </div>

        <form id="search-form" class="search" name="cse" role="search">
            {{ if .Site.Data.args.preliminary }}
                <input type="hidden" name="cx" value="{{ .Site.Data.args.preliminary_search_engine_id }}" />
            {{ else if or .Site.Data.args.archive .Site.Data.args.archive_landing }}
                <input type="hidden" name="cx" value="{{ .Site.Data.args.archive_search_engine_id }}" />
            {{ else }}
                <input type="hidden" name="cx" value="{{ .Site.Data.args.main_search_engine_id }}" />
            {{ end }}
            <input type="hidden" name="ie" value="utf-8" />
            <input type="hidden" name="hl" value="{{ .Page.Lang }}" />
            <input type="hidden" id="search-page-url" value="{{ "/search" | relLangURL }}" />
            <input id="search-textbox" class="search-textbox form-control" name="q" type="search" aria-label='{{ i18n "search" }}' placeholder='{{ i18n "search_label" }}' />
            <button id="search-close" title='{{ i18n "search_cancel" }}' type="reset" aria-label='{{ i18n "search_cancel" }}'>{{ partial "icon.html" "menu-close" }}</button>
        </form>
    </nav>
</header>

<script>
  function navigateToVersionSimple(selectedVersionPathSegment) {
    const currentFullPath = window.location.pathname;
    const currentVersionPathSegment = {{ $currentPathSegment | jsonify }};
    const selectedTargetSegment = selectedVersionPathSegment;

    console.log("--- Version Navigation (Menu) ---");
    console.log("Current Full Path:", currentFullPath);
    console.log("Current Version Segment (from Hugo):", currentVersionPathSegment);
    console.log("Selected Target Segment:", selectedTargetSegment);

    if (!currentVersionPathSegment && currentVersionPathSegment !== "" ) {
        console.error("CRITICAL: Could not determine current version path segment. Aborting reliable navigation.");
        const fallbackBase = selectedTargetSegment === 'latest' ? '/latest/' : ('/' + selectedTargetSegment + '/');
        console.warn("Attempting fallback navigation to:", fallbackBase);
        window.location.href = fallbackBase;
        return;
    }

    let contentPath = '';
    let foundContent = false;
    const knownContentPrefixes = ['docs/', 'blog/', 'news/', 'about/', 'faq/', 'operations/', 'tasks/', 'reference/', 'concepts/', 'samples/', 'download/', 'search/'];

    for (const prefix of knownContentPrefixes) {
        const index = currentFullPath.indexOf('/' + prefix);
        if (index > -1) {
            contentPath = currentFullPath.substring(index + 1);
            console.log("Found known prefix '" + prefix + "'. Determined Content Path:", contentPath);
            foundContent = true;
            break;
        }
    }

    if (!foundContent) {
        const currentBaseForCheck = currentVersionPathSegment === 'latest' ? '/latest/' : '/' + currentVersionPathSegment + '/';
        if (currentFullPath === '/' || currentFullPath === currentBaseForCheck || currentFullPath === currentBaseForCheck.slice(0,-1)) {
             contentPath = '';
             console.log("Current path is a version root. Navigating to target version root/docs root.");
        } else {
            console.warn("WARN: Could not find known content prefix in path '" + currentFullPath + "'. Navigating to target version's docs root.");
            contentPath = 'docs/'; // Default to docs root of target version
        }
    }
    
    let newBase = selectedTargetSegment === 'latest' ? '/latest/' : ('/' + selectedTargetSegment + '/');
    // Ensure newBase ends with a slash if contentPath is not empty or already starts with one
    if (contentPath !== "" && !newBase.endsWith('/')) {
        newBase += '/';
    }
    if (contentPath.startsWith('/')) { // Avoid double slash if contentPath accidentally starts with /
        contentPath = contentPath.substring(1);
    }
    
    let finalUrl = newBase + contentPath;
    finalUrl = finalUrl.replace(/\/\//g, '/'); // Replace double slashes

    console.log("Attempting navigation to:", finalUrl);
    window.location.href = finalUrl;
    console.log("--- End Version Navigation (Menu) ---");
  }
</script>