{{ $home := .Site.GetPage "home" }}
{{ $section := .Section }}
{{ $current := . }}

<header class="main-navigation {{ if .IsHome }}main-navigation--transparent{{ end }}">
    <nav class="main-navigation-wrapper container-l">
        <div class="main-navigation-header">
            <a id="brand" href="{{ $home.Permalink }}" aria-label="logotype">
                <span class="logo">{{ with resources.Get "inline_images/istio-logo-with-brand.svg" }}{{ .Content | safeHTML }}{{ end }}</span>
            </a>

            <button id="hamburger" class="main-navigation-toggle" aria-label="Open navigation">
                {{ partial "icon.html" "menu-hamburger" }}
            </button>

            <button id="menu-close" class="main-navigation-toggle" aria-label="Close navigation">
                {{ partial "icon.html" "menu-close" }}
            </button>
        </div>

        <div id="header-links" class="main-navigation-links-wrapper">
            <ul class="main-navigation-links">
                {{ $currentPage := .}}
                {{ range .Site.Menus.main }}
                    {{ $active := or (eq $currentPage.Title .Name) (or ($currentPage.HasMenuCurrent "main" .) ($currentPage.IsMenuCurrent "main" .)) }}
                    {{ if .HasChildren }}
                        <li class="main-navigation-links-item">
                            <a {{ if ne .URL "" }}href="{{ .URL | relLangURL  }}"{{end}} class="main-navigation-links-link has-dropdown {{ if $active }}active{{ end }}">
                                <span>{{ .Name }}</span>
                                {{ partial "icon.html" "dropdown-arrow" }}
                            </a>

                            <ul class="main-navigation-links-dropdown">
                                {{ range .Children }}
                                    <li class="main-navigation-links-dropdown-item">
                                        <a href="{{ .URL | relLangURL }}" class="main-navigation-links-link">{{ .Name }}</a>
                                    </li>
                                {{ end }}
                            </ul>
                        </li>
                    {{ else }}
                        <li class="main-navigation-links-item">
                            <a {{ if ne .URL "" }}href="{{ .URL | relLangURL }}"{{end}} class="main-navigation-links-link {{ if $active }}active{{ end }}">
                                <span>{{ .Name }}</span>
                            </a>
                        </li>
                    {{ end }}
                {{ end }}
            </ul>

            <div class="main-navigation-footer">
                <button id="search-show" class="search-show" title='{{ i18n "search" }}' aria-label='{{ i18n "search_label" }}'>{{ partial "icon.html" "magnifier" }}</button>
                <a href='{{ "/docs/overview/quickstart" | relLangURL }}' class="btn btn--primary" id="try-istio">{{ i18n "try_istio" }}</a>
            </div>
            
        </div>

        <form id="search-form" class="search" role="search" onsubmit="return redirectToSearch(event)">
        <input id="search-textbox" class="search-textbox form-control" name="q" type="search" placeholder="Search..." />
        <button id="search-close" type="reset">{{ partial "icon.html" "menu-close" }}</button>
        </form>

        <script>
        function redirectToSearch(event) {
            event.preventDefault();

            const query = document.getElementById('search-textbox').value.trim();
            if (!query) return false;

            const pathParts = window.location.pathname.split('/').filter(Boolean);
            let version = 'latest';
            let lang = '';

            for (const part of pathParts) {
                if (/^v[0-9.]+$/.test(part) || part === 'latest') {
                    version = part;
                } else if (/^[a-z]{2}(-[a-z]{2})?$/.test(part)) {
                    lang = part;
                }
            }
            const langSegment = (lang && lang !== 'en') ? `/${lang}` : '';
            const searchUrl = `/${version}${langSegment}/search/?q=${encodeURIComponent(query)}`;

            window.location.href = searchUrl;
            return false;
        }
        </script>
    </nav>
</header>
